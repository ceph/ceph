tasks:
- cephadm.shell:
    env: [sha1]
    mon.a:
      - while ceph orch upgrade status | jq '.in_progress' | grep true && ! ceph orch upgrade status | jq '.message' | grep Error ; do ceph orch ps ; ceph versions ; ceph orch upgrade status ; ceph health detail ; sleep 30 ; done
      - ceph orch ps
      - ceph versions
      - echo "wait for servicemap items w/ changing names to refresh"
      - sleep 60
      - ceph orch ps
      - ceph versions
      - ceph orch upgrade status
      - ceph health detail
      - time timeout 60 bash -c "until ceph versions | jq -e '.overall | length == 1'; do sleep 2; done"
      - time timeout 60 bash -c "until ceph versions | jq -e '.overall | keys' | grep $sha1; do sleep 2; done"
      - ceph orch ls | grep 'osd'
