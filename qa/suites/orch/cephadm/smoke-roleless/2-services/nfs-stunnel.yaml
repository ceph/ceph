tasks:
- vip:

# make sure cephadm notices the new IP
- cephadm.shell:
    host.a:
      - ceph orch device ls --refresh

# stop kernel nfs server, if running
- vip.exec:
    all-hosts:
      - systemctl stop nfs-server

- cephadm.shell:
    host.a:
      - ceph fs volume create foofs

# deploy nfs + ingress
- cephadm.apply:
    specs:
      - service_type: nfs
        service_id: foo
        placement:
          count: 2
        spec:
          port: 12049
          deploy_stunnel: true
          stunnel_port: 20490
          virtual_ip: "{{VIP0}}"
      - service_type: ingress
        service_id: nfs.foo
        spec:
          backend_service: nfs.foo
          frontend_port: 2049
          monitor_port: 9002
          virtual_ip: "{{VIP0}}/{{VIPPREFIXLEN}}"
- cephadm.wait_for_service:
    service: nfs.foo
- cephadm.wait_for_service:
    service: ingress.nfs.foo

## export and mount

- cephadm.shell:
    host.a:
      - ceph nfs export create cephfs --fsname foofs --cluster-id foo --pseudo-path /fake

- vip.exec:
    host.a:
      - podman run --network host quay.io/adk3798/stunnel:0.1.0.build-5 --endpoint {{VIP0}}:20490 --bind 0.0.0.0 --port 120490
      - mkdir /mnt/foo
      - sleep 5
      - mount -t nfs -o port=120490 127.0.0.1:/fake /mnt/foo
      - echo test > /mnt/foo/testfile
      - sync
